<html>
    <body>
        <h1>Will's super cool Game</h1>
        <h2>Waiting for players...</h2>

        <div id="game"></div>

        <script src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
        <script>
            function Game(){
                this.started = false;
                var elem = null;
                var players = [];
                var food = null;

                var update_game = function(){
                    for(var i = 0; i < players.length; i++){
                        var p = players[i];
                        var p_elem = document.getElementById("player_"+p.name);
                        p_elem.style.backgroundColor=p.colour;
                        p_elem.style.borderRadius="50%";
                        p_elem.style.width="20px";
                        p_elem.style.height="20px";
                        p_elem.style.position="absolute";
                        p_elem.style.top=p.y*20+"px";
                        p_elem.style.left=p.x*20+"px";
                        p_elem.style.color="white";
                        p_elem.style.textAlign="center";
                        p_elem.style.fontWeight="bold";
                        p_elem.innerHTML = p.score;
                    } 
                    var f_elem = document.getElementById("food");
                    f_elem.style.backgroundColor="white";
                    f_elem.style.borderRadius="50%";
                    f_elem.style.height="20px";
                    f_elem.style.width="20px";
                    f_elem.style.position="absolute";
                    f_elem.style.top=food.y*20+"px";
                    f_elem.style.left=food.x*20+"px";
                };

                this.init = function(id){
                    elem = document.getElementById(id);

                    elem.style.position="relative";
                    elem.style.display="block";
                    elem.style.margin="10px auto";
                    elem.style.backgroundColor="green";
                    elem.style.width="400px";
                    elem.style.height="400px";
                    elem.style.border="1px solid gray";
                    for(var i = 0; i < 20; i++){
                        for(var j = 0; j < 20; j++){
                            var square='<div style="top:'+i*20+'px;left:'+j*20+'px;" class="square"></div>';
                            elem.innerHTML+=square;
                        }
                    }
                    var squares = elem.getElementsByClassName("square");
                    for(var i = 0; i < squares.length; i++){
                        var square = squares[i];
                        square.style.position="absolute";
                        square.style.width="18px";
                        square.style.height="18px";
                        square.style.border="1px solid white";
                    }
                    elem.innerHTML+='<div id="food"></div>';
                    this.started = true;
                    food = {};
                    food.x=0;food.y=0;
                };
                
                this.update_player = function(player){
                    for(var i = 0; i < players.length; i++){
                        if(players[i].name==player.name){
                            players[i].x=player.x;
                            players[i].y=player.y;
                            players[i].score=player.score;
                            update_game();
                            return;
                        }
                    }
                    elem.innerHTML+='<div class="player" id="player_'+player.name+'"></div>';
                    players.push(player);
                    update_game();
                };

                this.update_food = function(f){
                    food = f;
                    update_game(); 
                }
            }
        </script>

        <script>
            var game = new Game();
            var name = prompt("Enter a player name:").replace(/ /g,'');
            var local_player = null;
            var remote_player = null;

            function bind_key_listeners(){
                 document.onkeydown = function(event){
                    if(event.keyCode == 38){
                        socket.emit('update player',JSON.stringify({name:name,direction:"up"}));
                    }
                    if(event.keyCode == 37){
                        socket.emit('update player',JSON.stringify({name:name,direction:"left"}));
                    }
                    if(event.keyCode == 39){
                        socket.emit('update player',JSON.stringify({name:name,direction:"right"}));
                    }
                    if(event.keyCode == 40){
                        socket.emit('update player',JSON.stringify({name:name,direction:"down"}));
                    }
                };  
            }

            var socket = io.connect('http://localhost:5000');
            socket.emit('new player', name);
            socket.on('game info', function(msg) {
                if(game.started == false){
                    bind_key_listeners();
                    game.init("game");
                    document.getElementsByTagName("h2")[0].remove();
                }

                game.update_food(msg.food);
                for(var i = 0; i < msg.players.length; i++){
                    game.update_player(msg.players[i]);
                }
           });
           socket.on('game end', function(msg){
                alert('Game over! Winner is '+msg.winner);
                document.onkeydown = null;
           });
        </script>
            </body>
</html>
